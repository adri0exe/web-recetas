<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recetario personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Sube y guarda tus recetas con fotos desde ordenador o movil.">
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="login-overlay" class="login-overlay" hidden>
    <div class="login-card">
      <p class="badge">Acceso privado</p>
      <h2>Inicia sesion</h2>
      <p class="muted">Solo los usuarios registrados pueden crear/editar recetas.</p>
      <form id="login-form" class="stack" autocomplete="off">
        <label class="field">
          <span>Correo</span>
          <input type="email" id="login-email" name="login-email" required placeholder="tu-correo@ejemplo.com">
        </label>
        <label class="field">
          <span>Contrasena</span>
          <input type="password" id="login-password" name="login-password" required placeholder="********">
        </label>
        <button type="submit" class="primary" id="login-btn">Entrar</button>
        <p class="login-error" id="login-error" hidden></p>
      </form>
    </div>
  </div>

  <header class="hero">
    <div class="auth-actions">
      <button type="button" class="ghost" id="login-toggle">Iniciar sesion</button>
      <div class="auth-user" id="auth-user" hidden></div>
      <button type="button" class="ghost danger" id="logout-btn" hidden>Cerrar sesion</button>
    </div>
    <h1>Recetas caseras</h1>
    <p class="lead">Guarda tus ideas en casa o fuera, con foto, ingredientes y pasos.</p>
    <div class="hero-actions">
      <button type="button" class="primary" id="toggle-form" hidden>Mostrar formulario</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel form-panel" id="form-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Anade una receta</p>
          <h2>Desde tu ordenador o tu movil</h2>
          <p class="muted">Cualquiera puede verlas; solo usuarios registrados pueden guardarlas.</p>
        </div>
        <div class="actions">
          <button type="button" id="exportar" class="ghost">Exportar (.json)</button>
          <label class="ghost file-label">
            Importar
            <input type="file" id="importar" accept="application/json" hidden>
          </label>
        </div>
      </div>

      <form id="recipe-form" class="stack" autocomplete="off">
        <label class="field">
          <span>Nombre de la receta *</span>
          <input id="titulo" name="titulo" type="text" required placeholder="Ej: Tarta de manzana">
        </label>

        <label class="field">
          <span>Descripcion breve</span>
          <input id="resumen" name="resumen" type="text" maxlength="180" placeholder="Por que es especial o para quien">
        </label>

        <div class="grid">
          <label class="field">
            <span>Ingredientes (uno por linea) *</span>
            <textarea id="ingredientes" name="ingredientes" rows="5" required placeholder="3 manzanas&#10;200 g harina&#10;1 huevo"></textarea>
          </label>

          <label class="field">
            <span>Pasos *</span>
            <textarea id="pasos" name="pasos" rows="5" required placeholder="1. Preparar la base&#10;2. Hornear 35 min"></textarea>
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span>Foto (opcional)</span>
            <input id="foto" name="foto" type="file" accept="image/*" capture="environment">
            <small class="muted">Puedes hacer la foto desde el movil o elegir una existente.</small>
          </label>

          <div class="preview" id="preview">
            <p class="muted">Previsualizacion</p>
            <img id="preview-img" alt="Previsualizacion de la receta" hidden>
          </div>
        </div>

        <button type="submit" class="primary" id="submit-btn">Guardar receta</button>
        <p class="muted" id="auth-hint">Inicia sesion para guardar recetas.</p>
      </form>
    </section>

    <section class="panel list-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Tu recetario</p>
          <h2>Listo para consultar</h2>
        </div>
      </div>
      <div id="recetas" class="recetas-list">
        <p class="empty">No hay recetas guardadas todavia.</p>
      </div>
    </section>
  </main>

  <template id="receta-template">
    <article class="receta">
      <div class="receta-header">
        <div>
          <p class="tag">Receta</p>
          <h3 class="receta-title"></h3>
          <p class="receta-summary"></p>
          <div class="receta-actions">
            <button type="button" class="ghost danger delete-btn" data-accion="eliminar" data-id="">Eliminar</button>
          </div>
        </div>
        <img class="receta-img" alt="">
      </div>
      <div class="receta-body">
        <div class="pill">Ingredientes</div>
        <ul class="receta-list ingredientes"></ul>
        <div class="pill">Pasos</div>
        <ol class="receta-list pasos"></ol>
      </div>
      <div class="receta-meta"></div>
    </article>
  </template>

  <script>
    (async function () {
      const SUPABASE_URL = "https://qooglpugptjfgitndkdz.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_me8vRoE4wcZoSGzxLSuofA_-vnSFFQr";
      const BUCKET_NAME = "recetas-fotos";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let recetas = [];
      let currentSession = null;

      const form = document.getElementById("recipe-form");
      const recetasContainer = document.getElementById("recetas");
      const fotoInput = document.getElementById("foto");
      const previewImg = document.getElementById("preview-img");
      const submitBtn = document.getElementById("submit-btn");
      const exportBtn = document.getElementById("exportar");
      const importInput = document.getElementById("importar");
      const template = document.getElementById("receta-template");
      const loginOverlay = document.getElementById("login-overlay");
      const loginForm = document.getElementById("login-form");
      const loginEmail = document.getElementById("login-email");
      const loginPassword = document.getElementById("login-password");
      const loginBtn = document.getElementById("login-btn");
      const loginError = document.getElementById("login-error");
      const loginToggle = document.getElementById("login-toggle");
      const logoutBtn = document.getElementById("logout-btn");
      const authHint = document.getElementById("auth-hint");
      const formPanel = document.getElementById("form-panel");
      const authUser = document.getElementById("auth-user");
      const toggleFormBtn = document.getElementById("toggle-form");
      let formVisible = false;

      attachListeners();
      await syncRecetas();
      await ensureSession();
      formPanel.classList.add("hidden");

      supabase.auth.onAuthStateChange((_event, session) => {
        currentSession = session;
        updateAuthUI();
      });

      function attachListeners() {
        form.addEventListener("submit", handleSubmit);
        loginForm.addEventListener("submit", handleLogin);
        loginToggle.addEventListener("click", showLogin);
        logoutBtn.addEventListener("click", handleLogout);
        toggleFormBtn.addEventListener("click", toggleFormVisibility);

        fotoInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) {
            hidePreview();
            return;
          }
          const dataUrl = await fileToDataURL(file);
          showPreview(dataUrl);
        });

        exportBtn.addEventListener("click", () => {
          const blob = new Blob([JSON.stringify(recetas, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recetas.json";
          a.click();
          URL.revokeObjectURL(url);
        });

        importInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          if (!currentSession) {
            alert("Inicia sesion para importar recetas.");
            showLogin();
            importInput.value = "";
            return;
          }
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!Array.isArray(data)) throw new Error("Formato inesperado");
            const normalizadas = data.map((item) => ({
              id: item.id || crypto.randomUUID(),
              titulo: item.titulo || "",
              resumen: item.resumen || "",
              ingredientes: item.ingredientes || [],
              pasos: item.pasos || [],
              foto_url: item.foto_url || item.foto || null,
              fecha: item.fecha || new Date().toISOString(),
              created_by: item.created_by || null,
            }));
            const { data: insertadas, error } = await supabase.from("recetas").insert(normalizadas).select();
            if (error) throw error;
            recetas.unshift(...(insertadas || []));
            renderRecetas();
          } catch (err) {
            alert("No se pudo importar el archivo. Asegurate de que es un .json exportado aqui.");
            console.error(err);
          } finally {
            importInput.value = "";
          }
        });

        recetasContainer.addEventListener("click", async (event) => {
          const btn = event.target.closest("[data-accion='eliminar']");
          if (!btn) return;
          if (!currentSession) {
            alert("Inicia sesion para eliminar recetas.");
            showLogin();
            return;
          }
          const id = btn.dataset.id;
          if (!id) return;
          const confirmar = confirm("Eliminar esta receta?");
          if (!confirmar) return;
          await eliminarReceta(id, btn);
        });
      }

      async function ensureSession() {
        const { data } = await supabase.auth.getSession();
        currentSession = data?.session || null;
        updateAuthUI();
      }

      function updateAuthUI() {
        const isLogged = Boolean(currentSession);
        loginToggle.hidden = isLogged;
        logoutBtn.hidden = !isLogged;
        if (isLogged && currentSession?.user?.email) {
          authUser.hidden = false;
          authUser.textContent = currentSession.user.email;
        } else {
          authUser.hidden = true;
          authUser.textContent = "";
        }
        authHint.textContent = isLogged
          ? "Puedes guardar, importar y eliminar recetas."
          : "Inicia sesion para guardar recetas.";
        formPanel.classList.toggle("hidden", !isLogged || !formVisible);
        submitBtn.disabled = !isLogged;
        toggleFormBtn.hidden = !isLogged;
        toggleFormBtn.textContent = formVisible ? "Ocultar formulario" : "Mostrar formulario";
        renderRecetas();
      }

      function toggleFormVisibility() {
        formVisible = !formVisible;
        formPanel.classList.toggle("hidden", !formVisible);
        toggleFormBtn.textContent = formVisible ? "Ocultar formulario" : "Mostrar formulario";
      }

      async function syncRecetas() {
        recetasContainer.innerHTML = '<p class="muted">Cargando recetas...</p>';
        try {
          const { data, error } = await supabase
            .from("recetas")
            .select("*")
            .order("fecha", { ascending: false });
          if (error) throw error;
          recetas = data || [];
          renderRecetas();
        } catch (err) {
          console.error("No se pudieron cargar las recetas", err);
          recetasContainer.innerHTML =
            '<p class="empty">No se pudieron cargar las recetas. Comprueba tu conexion.</p>';
        }
      }

      async function handleLogin(event) {
        event.preventDefault();
        loginBtn.disabled = true;
        loginError.hidden = true;
        loginError.textContent = "";
        try {
          const email = loginEmail.value.trim();
          const password = loginPassword.value;
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          currentSession = data.session;
          hideLogin();
          updateAuthUI();
        } catch (err) {
          loginError.hidden = false;
          loginError.textContent = err.message || "No se pudo iniciar sesion.";
        } finally {
          loginBtn.disabled = false;
        }
      }

      async function handleLogout() {
        await supabase.auth.signOut();
        currentSession = null;
        updateAuthUI();
      }

      async function handleSubmit(event) {
        event.preventDefault();
        if (!currentSession) {
          alert("Inicia sesion para guardar recetas.");
          showLogin();
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Guardando...";

        try {
          const titulo = form.titulo.value.trim();
          const resumen = form.resumen.value.trim();
          const ingredientes = toList(form.ingredientes.value);
          const pasos = toList(form.pasos.value);
          const fotoFile = fotoInput.files[0] || null;

          if (!titulo || !ingredientes.length || !pasos.length) {
            alert("Completa al menos el nombre, ingredientes y pasos.");
            return;
          }

          let fotoUrl = null;
          if (fotoFile) {
            fotoUrl = await subirFoto(fotoFile);
          }

          const nuevaReceta = {
            id: crypto.randomUUID(),
            titulo,
            resumen,
            ingredientes,
            pasos,
            foto_url: fotoUrl,
            fecha: new Date().toISOString(),
            created_by: currentSession?.user?.email || null,
          };

          const { data, error } = await supabase.from("recetas").insert(nuevaReceta).select().single();
          if (error) throw error;

          recetas.unshift(data);
          renderRecetas();
          form.reset();
          hidePreview();
        } catch (err) {
          console.error(err);
          const reason = err?.message || "No se pudo guardar la receta. Vuelve a intentarlo.";
          alert(reason);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Guardar receta";
        }
      }

      function renderRecetas() {
        recetasContainer.innerHTML = "";

        if (!recetas.length) {
          recetasContainer.innerHTML = '<p class="empty">No hay recetas guardadas todavia.</p>';
          return;
        }

        recetas.forEach((receta) => {
          const clone = template.content.cloneNode(true);
          const titleEl = clone.querySelector(".receta-title");
          const summaryEl = clone.querySelector(".receta-summary");
          const imgEl = clone.querySelector(".receta-img");
          const ingredientesEl = clone.querySelector(".ingredientes");
          const pasosEl = clone.querySelector(".pasos");
          const metaEl = clone.querySelector(".receta-meta");
          const deleteBtn = clone.querySelector(".delete-btn");

          titleEl.textContent = receta.titulo;
          summaryEl.textContent = receta.resumen || "Sin descripcion";
          const autor = receta.created_by || "Autor desconocido";
          metaEl.textContent = `${formatFecha(receta.fecha)} - ${autor}`;
          deleteBtn.dataset.id = receta.id;
          deleteBtn.disabled = !currentSession;
          deleteBtn.classList.toggle("hidden", !currentSession);
          deleteBtn.hidden = !currentSession;

          const fotoUrl = receta.foto_url || receta.foto || null;
          if (fotoUrl) {
            imgEl.src = fotoUrl;
            imgEl.alt = `Foto de ${receta.titulo}`;
            imgEl.hidden = false;
          } else {
            imgEl.hidden = true;
          }

          ingredientesEl.innerHTML = "";
          (receta.ingredientes || []).forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ingredientesEl.appendChild(li);
          });

          pasosEl.innerHTML = "";
          (receta.pasos || []).forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            pasosEl.appendChild(li);
          });

          recetasContainer.appendChild(clone);
        });
      }

      function toList(text) {
        return text
          .split(/\n+/)
          .map((line) => line.replace(/^\d+[.)]?\s*/, "").trim())
          .filter(Boolean);
      }

      function formatFecha(fecha) {
        const date = fecha ? new Date(fecha) : new Date();
        return new Intl.DateTimeFormat("es-ES", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      function hidePreview() {
        previewImg.hidden = true;
        previewImg.removeAttribute("src");
      }

      function showPreview(dataUrl) {
        previewImg.hidden = false;
        previewImg.src = dataUrl;
      }

      function showLogin() {
        loginOverlay.hidden = false;
        loginOverlay.style.display = "grid";
      }

      function hideLogin() {
        loginOverlay.hidden = true;
        loginOverlay.style.display = "none";
      }

      async function eliminarReceta(id, btn) {
        try {
          btn.disabled = true;
          const { error } = await supabase.from("recetas").delete().eq("id", id);
          if (error) throw error;
          recetas = recetas.filter((receta) => receta.id !== id);
          renderRecetas();
        } catch (err) {
          console.error(err);
          alert("No se pudo eliminar la receta. Intentalo de nuevo.");
        } finally {
          btn.disabled = false;
        }
      }

      async function subirFoto(file) {
        const fileName = `${crypto.randomUUID()}-${file.name}`;
        const { data, error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, file);
        if (error) throw error;
        const { data: publicData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(data.path);
        return publicData.publicUrl;
      }

      function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
          reader.readAsDataURL(file);
        });
      }
    })();
  </script>
</body>
</html>
