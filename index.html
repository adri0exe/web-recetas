<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recetario personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Sube y guarda tus recetas con fotos desde ordenador o movil.">
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="login-overlay" class="login-overlay" hidden>
    <div class="login-card">
      <button type="button" class="ghost close-login" id="login-close" aria-label="Cerrar inicio de sesion">Cerrar</button>
      <p class="badge">Acceso privado</p>
      <h2>Inicia sesion</h2>
      <p class="muted">Solo los usuarios registrados pueden crear/editar recetas.</p>
      <form id="login-form" class="stack" autocomplete="off">
        <label class="field">
          <span>Correo</span>
          <input type="email" id="login-email" name="login-email" required placeholder="tu-correo@ejemplo.com">
        </label>
        <label class="field">
          <span>Contrasena</span>
          <input type="password" id="login-password" name="login-password" required placeholder="********">
        </label>
        <button type="submit" class="primary" id="login-btn">Entrar</button>
        <p class="login-error" id="login-error" hidden></p>
      </form>
    </div>
  </div>

  <header class="hero">
    <div class="auth-actions">
      <button type="button" class="ghost" id="login-toggle">Iniciar sesion</button>
      <div class="auth-user" id="auth-user" hidden></div>
      <button type="button" class="ghost" id="favorites-toggle" hidden>Ver favoritos</button>
      <button type="button" class="ghost danger" id="logout-btn" hidden>Cerrar sesion</button>
    </div>
    <h1>Recetas caseras</h1>
    <div class="hero-actions">
      <button type="button" class="primary" id="toggle-form" hidden>Nueva receta</button>
    </div>
  </header>

  <div class="search-bar">
    <input type="search" id="search-receta" placeholder="Buscar recetas por nombre, descripcion o ingredientes">
  </div>

  <main class="layout">
    <section class="panel form-panel hidden" id="form-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Anade una receta</p>
          <h2>Desde tu ordenador o tu movil</h2>
          <p class="muted">Cualquiera puede verlas; solo usuarios registrados pueden guardarlas.</p>
        </div>
      </div>

      <form id="recipe-form" class="stack" autocomplete="off">
        <label class="field">
          <span>Nombre de la receta *</span>
          <input id="titulo" name="titulo" type="text" required placeholder="Ej: Tarta de manzana">
        </label>

        <label class="field">
          <span>Descripcion breve</span>
          <input id="resumen" name="resumen" type="text" maxlength="180" placeholder="Por que es especial o para quien">
        </label>

        <div class="grid">
          <div class="field">
            <span>Categoria</span>
            <div class="category-options" id="categoria-options">
              <label class="tag-option"><input type="radio" name="categoria" value=""> Sin categoria</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Entrantes"> Entrantes</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Primeros"> Primeros</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Acompanante"> Acompanante</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Guisos"> Guisos</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Postres"> Postres</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Rapidas"> Rapidas</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Bebidas"> Bebidas</label>
              <label class="tag-option"><input type="radio" name="categoria" value="Salsas"> Salsas</label>
            </div>
          </div>

          <div class="field">
            <span>Tags</span>
            <div class="tags-grid" id="tags-options">
              <label class="tag-option"><input type="checkbox" name="tags" value="Vegetariano"> Vegetariano</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Vegano"> Vegano</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Sin gluten"> Sin gluten</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Sin lactosa"> Sin lactosa</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Picante"> Picante</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Para congelar"> Para congelar</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Microondas"> Microondas</label>
              <label class="tag-option"><input type="checkbox" name="tags" value="Light"> Light</label>
            </div>
          </div>
        </div>

        <div class="grid">
          <label class="field">
            <span>Ingredientes (uno por linea) *</span>
            <textarea id="ingredientes" name="ingredientes" rows="5" required placeholder="3 manzanas&#10;200 g harina&#10;1 huevo"></textarea>
          </label>

          <label class="field">
            <span>Pasos *</span>
            <textarea id="pasos" name="pasos" rows="5" required placeholder="1. Preparar la base&#10;2. Hornear 35 min"></textarea>
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span>Foto (opcional)</span>
            <input id="foto" name="foto" type="file" accept="image/*" capture="environment">
            <small class="muted">Puedes hacer la foto desde el movil o elegir una existente.</small>
          </label>

          <div class="preview" id="preview">
            <p class="muted">Previsualizacion</p>
            <img id="preview-img" alt="Previsualizacion de la receta" hidden>
          </div>
        </div>

        <button type="submit" class="primary" id="submit-btn">Guardar receta</button>
        <p class="muted" id="auth-hint">Inicia sesion para guardar recetas.</p>
      </form>
    </section>

    <section class="panel list-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Tu recetario</p>
        </div>
      </div>
      <div id="recetas" class="recetas-list">
        <p class="empty">No hay recetas guardadas todavia.</p>
      </div>
      <div class="pagination" id="pagination" hidden>
        <button type="button" class="ghost" id="prev-page">Anterior</button>
        <span id="page-info"></span>
        <button type="button" class="ghost" id="next-page">Siguiente</button>
      </div>
    </section>
  </main>

  <template id="receta-template">
    <article class="receta">
      <div class="receta-header">
        <h3 class="receta-title"></h3>
        <p class="receta-summary"></p>
        <div class="receta-badges">
          <span class="badge category-badge" hidden></span>
          <div class="receta-tags"></div>
        </div>
        <div class="receta-actions">
          <button type="button" class="ghost star-btn" data-accion="favorita" data-id="" aria-label="Marcar como favorita">â˜†</button>
          <button type="button" class="ghost edit-btn" data-accion="editar" data-id="">Editar</button>
          <button type="button" class="ghost danger delete-btn" data-accion="eliminar" data-id="">Eliminar</button>
        </div>
      </div>
      <div class="receta-media">
        <img class="receta-img" alt="">
      </div>
      <div class="receta-body">
        <div class="pill">Ingredientes</div>
        <ul class="receta-list ingredientes"></ul>
        <div class="pill">Pasos</div>
        <ol class="receta-list pasos"></ol>
      </div>
      <div class="receta-meta">
        <span class="receta-meta-text"></span>
      </div>
    </article>
  </template>

  <div id="image-lightbox" class="image-lightbox hidden">
    <button type="button" id="close-lightbox">Cerrar</button>
    <img id="lightbox-img" alt="Foto de receta ampliada">
  </div>

  <script>
    (async function () {
      const SUPABASE_URL = "https://qooglpugptjfgitndkdz.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_me8vRoE4wcZoSGzxLSuofA_-vnSFFQr";
      const BUCKET_NAME = "recetas-fotos";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = supabase; // para poder usar supabase.auth.getUser() desde la consola

      let recetas = [];
      let currentSession = null;

      const form = document.getElementById("recipe-form");
      const recetasContainer = document.getElementById("recetas");
      const fotoInput = document.getElementById("foto");
      const previewImg = document.getElementById("preview-img");
      const submitBtn = document.getElementById("submit-btn");
      const template = document.getElementById("receta-template");
      const loginOverlay = document.getElementById("login-overlay");
      const loginForm = document.getElementById("login-form");
      const loginEmail = document.getElementById("login-email");
      const loginPassword = document.getElementById("login-password");
      const loginBtn = document.getElementById("login-btn");
      const loginError = document.getElementById("login-error");
      const loginToggle = document.getElementById("login-toggle");
      const loginClose = document.getElementById("login-close");
      const logoutBtn = document.getElementById("logout-btn");
      const favoritesToggle = document.getElementById("favorites-toggle");
      const authHint = document.getElementById("auth-hint");
      const formPanel = document.getElementById("form-panel");
      const authUser = document.getElementById("auth-user");
      const toggleFormBtn = document.getElementById("toggle-form");
      const lightbox = document.getElementById("image-lightbox");
      const lightboxImg = document.getElementById("lightbox-img");
      const closeLightboxBtn = document.getElementById("close-lightbox");
      const searchInput = document.getElementById("search-receta");
      const tagInputs = Array.from(document.querySelectorAll('input[name="tags"]'));
      const categoryInputs = Array.from(document.querySelectorAll('input[name="categoria"]'));
      const pagination = document.getElementById("pagination");
      const prevPageBtn = document.getElementById("prev-page");
      const nextPageBtn = document.getElementById("next-page");
      const pageInfo = document.getElementById("page-info");
      let formVisible = false;
      let searchTerm = "";
      let showFavoritesOnly = false;
      let currentPage = 1;
      const pageSize = 5;

      attachListeners();
      await syncRecetas();
      await ensureSession();
      formPanel.classList.add("hidden");

      supabase.auth.onAuthStateChange(async (_event, session) => {
        currentSession = session;
        await refreshUserMeta();
        updateAuthUI();
      });

      function attachListeners() {
        form.addEventListener("submit", handleSubmit);
        loginForm.addEventListener("submit", handleLogin);
        loginToggle.addEventListener("click", showLogin);
        loginClose.addEventListener("click", hideLogin);
        logoutBtn.addEventListener("click", handleLogout);
        toggleFormBtn.addEventListener("click", toggleFormVisibility);
        closeLightboxBtn.addEventListener("click", hideLightbox);
        lightbox.addEventListener("click", (e) => {
          if (e.target === lightbox) hideLightbox();
        });
        searchInput.addEventListener("input", handleSearch);
        favoritesToggle.addEventListener("click", toggleFavorites);
        prevPageBtn.addEventListener("click", () => changePage(-1));
        nextPageBtn.addEventListener("click", () => changePage(1));

        fotoInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) {
            hidePreview();
            return;
          }
          const dataUrl = await fileToDataURL(file);
          showPreview(dataUrl);
        });

        recetasContainer.addEventListener("click", async (event) => {
          const img = event.target.closest(".receta-img");
          if (img && img.dataset.full) {
            showLightbox(img.dataset.full, img.alt || "Foto de la receta");
            return;
          }

          const editBtn = event.target.closest("[data-accion='editar']");
          if (editBtn) {
            if (!currentSession) {
              alert("Inicia sesion para editar recetas.");
              showLogin();
              return;
            }
            const id = editBtn.dataset.id;
            if (!id) return;
            const receta = recetas.find((r) => r.id === id);
            if (!receta) return;
            formVisible = true;
            formPanel.classList.remove("hidden");
            toggleFormBtn.textContent = "Ocultar formulario";
            form.titulo.value = receta.titulo || "";
            form.resumen.value = receta.resumen || "";
            form.ingredientes.value = (receta.ingredientes || []).join("\n");
            form.pasos.value = (receta.pasos || []).join("\n");
            const cat = receta.categoria || "";
            categoryInputs.forEach((input) => {
              input.checked = input.value === cat;
            });
            tagInputs.forEach((input) => {
              input.checked = (receta.tags || []).includes(input.value);
            });
            form.dataset.editingId = id;
            window.scrollTo({ top: 0, behavior: "smooth" });
            return;
          }

          const starBtn = event.target.closest("[data-accion='favorita']");
          if (starBtn) {
            if (!currentSession) {
              alert("Inicia sesion para marcar favoritas.");
              showLogin();
              return;
            }
            const id = starBtn.dataset.id;
            if (!id) return;
            await toggleFavorita(id, starBtn);
            return;
          }

          const btn = event.target.closest("[data-accion='eliminar']");
          if (!btn) return;
          if (!currentSession) {
            alert("Inicia sesion para eliminar recetas.");
            showLogin();
            return;
          }
          const id = btn.dataset.id;
          if (!id) return;
          const confirmar = confirm("Eliminar esta receta?");
          if (!confirmar) return;
          await eliminarReceta(id, btn);
        });
      }

      async function ensureSession() {
        const { data } = await supabase.auth.getSession();
        currentSession = data?.session || null;
        await refreshUserMeta();
        updateAuthUI();
      }

      function updateAuthUI() {
        const isLogged = Boolean(currentSession);
        loginToggle.hidden = isLogged;
        logoutBtn.hidden = !isLogged;
        favoritesToggle.hidden = !isLogged;
        favoritesToggle.textContent = showFavoritesOnly ? "Ver todas" : "Ver favoritos";
        if (isLogged && currentSession?.user) {
          authUser.hidden = false;
          authUser.textContent = getDisplayName(currentSession.user);
        } else {
          authUser.hidden = true;
          authUser.textContent = "";
        }
        authHint.textContent = isLogged
          ? "Puedes guardar y eliminar recetas."
          : "Inicia sesion para guardar recetas.";
        formPanel.classList.toggle("hidden", !isLogged || !formVisible);
        submitBtn.disabled = !isLogged;
        toggleFormBtn.hidden = !isLogged;
        toggleFormBtn.textContent = formVisible ? "Ocultar formulario" : "Nueva receta";
        renderRecetas();
      }

      function toggleFormVisibility() {
        formVisible = !formVisible;
        formPanel.classList.toggle("hidden", !formVisible);
        toggleFormBtn.textContent = formVisible ? "Ocultar formulario" : "Nueva receta";
      }

      async function syncRecetas() {
        recetasContainer.innerHTML = '<p class="muted">Cargando recetas...</p>';
        try {
          const { data, error } = await supabase
            .from("recetas")
            .select("*")
            .order("fecha", { ascending: false });
          if (error) throw error;
          recetas = data || [];
          currentPage = 1;
          renderRecetas();
        } catch (err) {
          console.error("No se pudieron cargar las recetas", err);
          recetasContainer.innerHTML =
            '<p class="empty">No se pudieron cargar las recetas. Comprueba tu conexion.</p>';
        }
      }

      async function handleLogin(event) {
        event.preventDefault();
        loginBtn.disabled = true;
        loginError.hidden = true;
        loginError.textContent = "";
        try {
          const email = loginEmail.value.trim();
          const password = loginPassword.value;
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          currentSession = data.session;
          await refreshUserMeta();
          hideLogin();
          updateAuthUI();
        } catch (err) {
          loginError.hidden = false;
          loginError.textContent = err.message || "No se pudo iniciar sesion.";
        } finally {
          loginBtn.disabled = false;
        }
      }

      async function handleLogout() {
        await supabase.auth.signOut();
        currentSession = null;
        updateAuthUI();
      }

      async function handleSubmit(event) {
        event.preventDefault();
        if (!currentSession) {
          alert("Inicia sesion para guardar recetas.");
          showLogin();
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "Guardando...";

        try {
          const titulo = form.titulo.value.trim();
          const resumen = form.resumen.value.trim();
        const ingredientes = toList(form.ingredientes.value);
        const pasos = toList(form.pasos.value);
        const fotoFile = fotoInput.files[0] || null;
        const categoria = (categoryInputs.find((input) => input.checked)?.value || "").trim();
        const tags = tagInputs.filter((input) => input.checked).map((input) => input.value);

        if (!titulo || !ingredientes.length || !pasos.length) {
          alert("Completa al menos el nombre, ingredientes y pasos.");
          return;
        }

          const editingId = form.dataset.editingId;
          if (editingId) {
            const recetaActual = recetas.find((r) => r.id === editingId) || {};
            let fotoUrl = recetaActual.foto_url || recetaActual.foto || null;
            if (fotoFile) {
              fotoUrl = await subirFoto(fotoFile);
            }

            const { data, error } = await supabase
              .from("recetas")
              .update({
                titulo,
                resumen,
                ingredientes,
                pasos,
                foto_url: fotoUrl ?? null,
                categoria,
                tags,
              })
              .eq("id", editingId)
              .select()
              .single();
            if (error) throw error;
            const idx = recetas.findIndex((r) => r.id === editingId);
            if (idx !== -1) recetas[idx] = { ...recetas[idx], ...data };
          } else {
            let fotoUrl = null;
            if (fotoFile) {
              fotoUrl = await subirFoto(fotoFile);
            }

            const nuevaReceta = {
              id: crypto.randomUUID(),
              titulo,
              resumen,
              ingredientes,
              pasos,
              foto_url: fotoUrl,
              fecha: new Date().toISOString(),
              favorita: false,
              categoria,
              tags,
              created_by: currentSession?.user?.email || null,
            };

            const { data, error } = await supabase.from("recetas").insert(nuevaReceta).select().single();
            if (error) throw error;

            recetas.unshift(data);
          }

          renderRecetas();
          form.reset();
          delete form.dataset.editingId;
          hidePreview();
          formVisible = false;
          formPanel.classList.add("hidden");
          toggleFormBtn.textContent = "Nueva receta";
        } catch (err) {
          console.error(err);
          const reason = err?.message || "No se pudo guardar la receta. Vuelve a intentarlo.";
          alert(reason);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Guardar receta";
        }
      }

      function renderRecetas() {
        recetasContainer.innerHTML = "";

        const filtradas = filterRecetas(recetas, searchTerm, showFavoritesOnly);

        if (!filtradas.length) {
          recetasContainer.innerHTML = '<p class="empty">No hay recetas guardadas todavia.</p>';
          pagination.hidden = true;
          return;
        }

        const totalPages = Math.max(1, Math.ceil(filtradas.length / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * pageSize;
        const paginadas = filtradas.slice(start, start + pageSize);

        paginadas.forEach((receta) => {
          const clone = template.content.cloneNode(true);
          const titleEl = clone.querySelector(".receta-title");
          const summaryEl = clone.querySelector(".receta-summary");
          const imgEl = clone.querySelector(".receta-img");
          const ingredientesEl = clone.querySelector(".ingredientes");
          const pasosEl = clone.querySelector(".pasos");
          const metaEl = clone.querySelector(".receta-meta-text");
          const deleteBtn = clone.querySelector(".delete-btn");
          const starBtn = clone.querySelector(".star-btn");
          const editBtn = clone.querySelector(".edit-btn");

          titleEl.textContent = receta.titulo;
          summaryEl.textContent = receta.resumen || "Sin descripcion";
          const autor = receta.created_by || "Autor desconocido";
          metaEl.textContent = `${formatFecha(receta.fecha)} - ${autor}`;
        deleteBtn.dataset.id = receta.id;
        deleteBtn.disabled = !currentSession;
        deleteBtn.classList.toggle("hidden", !currentSession);
        deleteBtn.hidden = !currentSession;
        starBtn.dataset.id = receta.id;
        starBtn.disabled = !currentSession;
        starBtn.classList.toggle("hidden", !currentSession);
        starBtn.hidden = !currentSession;
        const favorita = Boolean(receta.favorita);
        starBtn.textContent = favorita ? "\u2605" : "\u2606";
        starBtn.classList.toggle("starred", favorita);
        editBtn.dataset.id = receta.id;
        editBtn.disabled = !currentSession;
        editBtn.classList.toggle("hidden", !currentSession);
        editBtn.hidden = !currentSession;

          const fotoUrl = receta.foto_url || receta.foto || null;
          if (fotoUrl) {
            imgEl.src = fotoUrl;
            imgEl.alt = `Foto de ${receta.titulo}`;
            imgEl.dataset.full = fotoUrl;
            imgEl.hidden = false;
          } else {
            imgEl.hidden = true;
          }

          ingredientesEl.innerHTML = "";
          (receta.ingredientes || []).forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ingredientesEl.appendChild(li);
          });

          pasosEl.innerHTML = "";
          (receta.pasos || []).forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            pasosEl.appendChild(li);
          });

          const categoriaBadge = clone.querySelector(".category-badge");
          if (receta.categoria) {
            categoriaBadge.textContent = receta.categoria;
            categoriaBadge.hidden = false;
          } else {
            categoriaBadge.hidden = true;
          }

          const tagsWrap = clone.querySelector(".receta-tags");
          tagsWrap.innerHTML = "";
          (receta.tags || []).forEach((tag) => {
            const chip = document.createElement("span");
            chip.className = "tag-chip";
            chip.textContent = tag;
            tagsWrap.appendChild(chip);
          });

          recetasContainer.appendChild(clone);
        });

        pagination.hidden = false;
        pageInfo.textContent = `Pagina ${currentPage} de ${totalPages}`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      }

      function handleSearch(event) {
        searchTerm = (event.target.value || "").trim().toLowerCase();
        currentPage = 1;
        renderRecetas();
      }

      function filterRecetas(lista, term, soloFavoritas) {
        let resultado = lista;
        if (soloFavoritas) {
          resultado = resultado.filter((receta) => Boolean(receta.favorita));
        }
        if (!term) return resultado;
        const query = normalizeText(term);
        return resultado.filter((receta) => {
          const titulo = normalizeText(receta.titulo);
          const resumen = normalizeText(receta.resumen);
          const ingredientes = normalizeText((receta.ingredientes || []).join(" "));
          const pasos = normalizeText((receta.pasos || []).join(" "));
          const categoria = normalizeText(receta.categoria);
          const tags = normalizeText((receta.tags || []).join(" "));
          return (
            titulo.includes(query) ||
            resumen.includes(query) ||
            ingredientes.includes(query) ||
            pasos.includes(query) ||
            categoria.includes(query) ||
            tags.includes(query)
          );
        });
      }

      function normalizeText(value) {
        return (value || "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function toggleFavorites() {
        showFavoritesOnly = !showFavoritesOnly;
        favoritesToggle.textContent = showFavoritesOnly ? "Ver todas" : "Ver favoritos";
        currentPage = 1;
        renderRecetas();
      }

      function changePage(delta) {
        currentPage = Math.max(1, currentPage + delta);
        renderRecetas();
      }

      function getDisplayName(user) {
        if (!user) return "";
        const meta = user.user_metadata || user.raw_user_meta_data || {};
        if (meta.name) return meta.name;
        if (meta.nombre) return meta.nombre;
        if (user.email) return user.email.split("@")[0];
        return "Usuario";
      }

      async function refreshUserMeta() {
        try {
          const { data } = await supabase.auth.getUser();
          if (data?.user) {
            currentSession = currentSession ? { ...currentSession, user: data.user } : { user: data.user };
          }
        } catch (err) {
          console.warn("No se pudo refrescar el usuario", err);
        }
      }

      function toList(text) {
        return text
          .split(/\n+/)
          .map((line) => line.trim())
          .filter(Boolean);
      }

      function formatFecha(fecha) {
        const date = fecha ? new Date(fecha) : new Date();
        return new Intl.DateTimeFormat("es-ES", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      function hidePreview() {
        previewImg.hidden = true;
        previewImg.removeAttribute("src");
      }

      function showPreview(dataUrl) {
        previewImg.hidden = false;
        previewImg.src = dataUrl;
      }

      function showLogin() {
        loginOverlay.hidden = false;
        loginOverlay.style.display = "grid";
      }

      function hideLogin() {
        loginOverlay.hidden = true;
        loginOverlay.style.display = "none";
      }

      async function eliminarReceta(id, btn) {
        try {
          btn.disabled = true;
          const { error } = await supabase.from("recetas").delete().eq("id", id);
          if (error) throw error;
          recetas = recetas.filter((receta) => receta.id !== id);
          renderRecetas();
        } catch (err) {
          console.error(err);
          alert("No se pudo eliminar la receta. Intentalo de nuevo.");
        } finally {
          btn.disabled = false;
        }
      }

      async function subirFoto(file) {
        const fileName = `${crypto.randomUUID()}-${file.name}`;
        const { data, error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, file);
        if (error) throw error;
        const { data: publicData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(data.path);
        return publicData.publicUrl;
      }

      async function toggleFavorita(id, btn) {
        try {
          btn.disabled = true;
          const receta = recetas.find((r) => r.id === id);
          const nuevaMarca = !receta?.favorita;
          const { error } = await supabase.from("recetas").update({ favorita: nuevaMarca }).eq("id", id);
          if (error) throw error;
          if (receta) receta.favorita = nuevaMarca;
          btn.textContent = nuevaMarca ? "\u2605" : "\u2606";
          btn.classList.toggle("starred", nuevaMarca);
        } catch (err) {
          console.error(err);
          alert("No se pudo actualizar favorito. Intentalo de nuevo.");
        } finally {
          btn.disabled = false;
        }
      }

      function showLightbox(url, alt) {
        lightboxImg.src = url;
        lightboxImg.alt = alt || "Foto de receta";
        lightbox.classList.remove("hidden");
      }

      function hideLightbox() {
        lightbox.classList.add("hidden");
        lightboxImg.removeAttribute("src");
        lightboxImg.removeAttribute("alt");
      }

      function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
          reader.readAsDataURL(file);
        });
      }
    })();
  </script>
</body>
</html>
