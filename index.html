<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recetario personal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Sube y guarda tus recetas con fotos desde ordenador o móvil.">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="hero">
    <p class="badge">Siempre contigo</p>
    <h1>Recetas caseras</h1>
    <p class="lead">Guarda tus ideas en casa o fuera, con foto, ingredientes y pasos.</p>
  </header>

  <main class="layout">
    <section class="panel form-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Añade una receta</p>
          <h2>Desde tu ordenador o tu móvil</h2>
          <p class="muted">Se guarda en este dispositivo; usa exportar/importar para moverlas.</p>
        </div>
        <div class="actions">
          <button type="button" id="exportar" class="ghost">Exportar (.json)</button>
          <label class="ghost file-label">
            Importar
            <input type="file" id="importar" accept="application/json" hidden>
          </label>
        </div>
      </div>

      <form id="recipe-form" class="stack" autocomplete="off">
        <label class="field">
          <span>Nombre de la receta *</span>
          <input id="titulo" name="titulo" type="text" required placeholder="Ej: Tarta de manzana">
        </label>

        <label class="field">
          <span>Descripción breve</span>
          <input id="resumen" name="resumen" type="text" maxlength="180" placeholder="Por qué es especial o para quién">
        </label>

        <div class="grid">
          <label class="field">
            <span>Ingredientes (uno por línea) *</span>
            <textarea id="ingredientes" name="ingredientes" rows="5" required placeholder="3 manzanas&#10;200 g harina&#10;1 huevo"></textarea>
          </label>

          <label class="field">
            <span>Pasos *</span>
            <textarea id="pasos" name="pasos" rows="5" required placeholder="1. Preparar la base&#10;2. Hornear 35 min"></textarea>
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span>Foto (opcional)</span>
            <input id="foto" name="foto" type="file" accept="image/*" capture="environment">
            <small class="muted">Puedes hacer la foto desde el móvil o elegir una existente.</small>
          </label>

          <div class="preview" id="preview">
            <p class="muted">Previsualización</p>
            <img id="preview-img" alt="Previsualización de la receta" hidden>
          </div>
        </div>

        <button type="submit" class="primary" id="submit-btn">Guardar receta</button>
      </form>
    </section>

    <section class="panel list-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Tu recetario</p>
          <h2>Listo para consultar</h2>
        </div>
      </div>
      <div id="recetas" class="recetas-list">
        <p class="empty">No hay recetas guardadas todavía.</p>
      </div>
    </section>
  </main>

  <template id="receta-template">
    <article class="receta">
      <div class="receta-header">
        <div>
          <p class="tag">Receta</p>
          <h3 class="receta-title"></h3>
          <p class="receta-summary"></p>
        </div>
        <img class="receta-img" alt="">
      </div>
      <div class="receta-body">
        <div class="pill">Ingredientes</div>
        <ul class="receta-list ingredientes"></ul>
        <div class="pill">Pasos</div>
        <ol class="receta-list pasos"></ol>
      </div>
      <div class="receta-meta"></div>
    </article>
  </template>

  <script>
    (function () {
      const STORAGE_KEY = "recetas_guardadas";
      const recetas = loadRecetas();
      const form = document.getElementById("recipe-form");
      const recetasContainer = document.getElementById("recetas");
      const fotoInput = document.getElementById("foto");
      const previewImg = document.getElementById("preview-img");
      const submitBtn = document.getElementById("submit-btn");
      const exportBtn = document.getElementById("exportar");
      const importInput = document.getElementById("importar");
      const template = document.getElementById("receta-template");

      renderRecetas();
      attachListeners();

      function loadRecetas() {
        try {
          const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          return Array.isArray(data) ? data : [];
        } catch (err) {
          console.warn("No se pudieron leer las recetas guardadas", err);
          return [];
        }
      }

      function saveRecetas() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(recetas));
      }

      function attachListeners() {
        form.addEventListener("submit", handleSubmit);

        fotoInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) {
            hidePreview();
            return;
          }
          const dataUrl = await fileToDataURL(file);
          showPreview(dataUrl);
        });

        exportBtn.addEventListener("click", () => {
          const blob = new Blob([JSON.stringify(recetas, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recetas.json";
          a.click();
          URL.revokeObjectURL(url);
        });

        importInput.addEventListener("change", async (event) => {
          const file = event.target.files[0];
          if (!file) return;
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!Array.isArray(data)) throw new Error("Formato inesperado");
            recetas.splice(0, recetas.length, ...data);
            saveRecetas();
            renderRecetas();
          } catch (err) {
            alert("No se pudo importar el archivo. Asegúrate de que es un .json exportado aquí.");
            console.error(err);
          } finally {
            importInput.value = "";
          }
        });
      }

      async function handleSubmit(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = "Guardando...";

        try {
          const titulo = form.titulo.value.trim();
          const resumen = form.resumen.value.trim();
          const ingredientes = toList(form.ingredientes.value);
          const pasos = toList(form.pasos.value);
          const foto = fotoInput.files[0] ? await fileToDataURL(fotoInput.files[0]) : null;

          if (!titulo || !ingredientes.length || !pasos.length) {
            alert("Completa al menos el nombre, ingredientes y pasos.");
            return;
          }

          const nuevaReceta = {
            id: Date.now(),
            titulo,
            resumen,
            ingredientes,
            pasos,
            foto,
            fecha: new Date().toISOString(),
          };

          recetas.unshift(nuevaReceta);
          saveRecetas();
          renderRecetas();
          form.reset();
          hidePreview();
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Guardar receta";
        }
      }

      function renderRecetas() {
        recetasContainer.innerHTML = "";

        if (!recetas.length) {
          recetasContainer.innerHTML = '<p class="empty">No hay recetas guardadas todavía.</p>';
          return;
        }

        recetas.forEach((receta) => {
          const clone = template.content.cloneNode(true);
          const titleEl = clone.querySelector(".receta-title");
          const summaryEl = clone.querySelector(".receta-summary");
          const imgEl = clone.querySelector(".receta-img");
          const ingredientesEl = clone.querySelector(".ingredientes");
          const pasosEl = clone.querySelector(".pasos");
          const metaEl = clone.querySelector(".receta-meta");

          titleEl.textContent = receta.titulo;
          summaryEl.textContent = receta.resumen || "Sin descripción";
          metaEl.textContent = formatFecha(receta.fecha);

          if (receta.foto) {
            imgEl.src = receta.foto;
            imgEl.alt = `Foto de ${receta.titulo}`;
            imgEl.hidden = false;
          } else {
            imgEl.hidden = true;
          }

          ingredientesEl.innerHTML = "";
          receta.ingredientes.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            ingredientesEl.appendChild(li);
          });

          pasosEl.innerHTML = "";
          receta.pasos.forEach((item) => {
            const li = document.createElement("li");
            li.textContent = item;
            pasosEl.appendChild(li);
          });

          recetasContainer.appendChild(clone);
        });
      }

      function toList(text) {
        return text
          .split(/\n+/)
          .map((line) => line.replace(/^\d+[.)]?\s*/, "").trim())
          .filter(Boolean);
      }

      function formatFecha(fecha) {
        const date = fecha ? new Date(fecha) : new Date();
        return new Intl.DateTimeFormat("es-ES", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      function hidePreview() {
        previewImg.hidden = true;
        previewImg.removeAttribute("src");
      }

      function showPreview(dataUrl) {
        previewImg.hidden = false;
        previewImg.src = dataUrl;
      }

      function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
          reader.readAsDataURL(file);
        });
      }
    })();
  </script>
</body>
</html>
